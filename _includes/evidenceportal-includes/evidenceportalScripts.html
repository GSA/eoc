<script src="{{ site.baseurl }}/assets/js/tom-select.complete.min.js"></script>
<!-- <script type="text/javascript">
  let selectedAgency = "";
  let selectedTopics = [];
  let selectedDateSort = "";

  const topicList = [
    { value: "Impact", agency: "National Institutes of Health" },
    { value: "Metascience", agency: "National Institutes of Health" },
    { value: "Evaluation", agency: "National Institutes of Health" },
    { value: "Stewardship", agency: "National Institutes of Health" },
    { value: "Housing", agency: "Department of the Treasury" },
    {
      value: "Workforce Development",
      agency: "Department of the Treasury",
    },
    {
      value: "State and Local Governments",
      agency: "Department of the Treasury",
    },
  ];

  const agencySelect = new TomSelect("#agencySelect", {
    create: false,
    allowEmptyOption: true,
    onChange: (value) => {
      selectedAgency = value || "";
      if (selectedAgency) {
        updateTopicsByAgency(selectedAgency);
      } else {
        resetTopics();
      }
      filterArticles();
    },
  });

  const topicSelect = new TomSelect("#topicSelect", {
    plugins: ["remove_button"],
    create: false,
    persist: false,
    onChange: (values) => {
      selectedTopics = values || [];

      if (selectedTopics.length > 0) {
        const topicAgency = topicList.find(
          (t) => t.value === selectedTopics[0]
        ).agency;
        selectedAgency = topicAgency;

        updateAgencyDropdown(topicAgency); // Update agency dropdown options
        updateTopicsByAgency(topicAgency); // Update topic options
      } else {
        resetAgency();
        resetTopics();
        selectedAgency = "";
      }

      filterArticles();
    },
  });

  const dateSelect = new TomSelect("#dateSelect", {
    create: false,
    allowEmptyOption: true,
    onChange: (value) => {
      selectedDateSort = value || "";
      filterArticles();
    },
  });

  document
    .getElementById("projSearch")
    .addEventListener("input", filterArticles);

  document.getElementById("clearFilters").addEventListener("click", () => {
    selectedDateSort = "";
    selectedAgency = "";
    selectedTopics = [];

    dateSelect.clear(true);
    agencySelect.clear(true);
    topicSelect.clear(true);

    resetAgency();
    resetTopics();

    document.getElementById("projSearch").value = "";

    filterArticles();
  });

  function updateTopicsByAgency(agency) {
    topicSelect.clearOptions();

    topicList.forEach((topic) => {
      if (topic.agency === agency) {
        topicSelect.addOption({ value: topic.value, text: topic.value });
      }
    });

    topicSelect.refreshOptions(false);
  }

  function resetTopics() {
    topicSelect.clearOptions();

    topicList.forEach((topic) => {
      topicSelect.addOption({ value: topic.value, text: topic.value });
    });

    topicSelect.refreshOptions(false);
  }

  function updateAgencyDropdown(agency) {
    agencySelect.clearOptions();

    agencySelect.addOption({ value: agency, text: agency });

    agencySelect.refreshOptions(false);
    agencySelect.setValue(agency, true);
  }

  function resetAgency() {
    agencySelect.clearOptions();

    const agencies = [...new Set(topicList.map((t) => t.agency))];

    agencies.forEach((agency) => {
      agencySelect.addOption({ value: agency, text: agency });
    });

    agencySelect.refreshOptions(false);
  }

  function filterArticles() {
    const searchText = document
      .getElementById("projSearch")
      .value.trim()
      .toLowerCase();

    const articles = document.querySelectorAll("article");

    articles.forEach((article) => {
      let textContent = article.textContent.replace(/\s+/g, " ").toLowerCase();
      let agency = (article.dataset.agency || "").toLowerCase();
      let topicsJson = article.dataset.topic || "[]";
      let topicsArray = [];

      try {
        topicsArray = JSON.parse(topicsJson).map((topic) =>
          topic.toLowerCase()
        );
      } catch (e) {
        console.error("Error parsing topics JSON:", topicsJson);
      }

      const matchSearch = searchText === "" || textContent.includes(searchText);
      const matchAgency =
        selectedAgency === "" || agency.includes(selectedAgency.toLowerCase());
      const matchTopics =
        selectedTopics.length === 0 ||
        selectedTopics.some((topic) =>
          topicsArray.includes(topic.toLowerCase())
        );

      if (matchSearch && matchAgency && matchTopics) {
        article.style.display = "block";
      } else {
        article.style.display = "none";
      }
    });
  }

  // On load, show all agency options
  resetAgency();
  resetTopics();
</script> -->

<!--New common js-->
<!-- <script>
  function initFilters({ topics, dateOptions = [] }) {
    let selectedAgency = "";
    let selectedTopics = [];
    let selectedDateSort = "";

    const agencies = [...new Set(topics.map((t) => t.agency))];

    const agencySelect = new TomSelect("#agencySelect", {
      create: false,
      allowEmptyOption: true,
      onChange: (value) => {
        selectedAgency = value || "";
        if (selectedAgency) {
          updateTopicsByAgency(selectedAgency);
        } else {
          resetTopics();
        }
        filterArticles();
      },
    });

    const topicSelect = new TomSelect("#topicSelect", {
      plugins: ["remove_button"],
      create: false,
      persist: false,
      onChange: (values) => {
        selectedTopics = values || [];
        if (selectedTopics.length > 0) {
          const topicAgency = topics.find(
            (t) => t.value === selectedTopics[0]
          )?.agency;
          selectedAgency = topicAgency;
          updateAgencyDropdown(topicAgency);
          updateTopicsByAgency(topicAgency);
        } else {
          resetAgency();
          resetTopics();
          selectedAgency = "";
        }
        filterArticles();
      },
    });

    const dateSelect = new TomSelect("#dateSelect", {
      create: false,
      allowEmptyOption: true,
      options: dateOptions.map((d) => ({ value: d, text: d })),
      onChange: (value) => {
        selectedDateSort = value || "";
        filterArticles();
      },
    });

    document
      .getElementById("projSearch")
      ?.addEventListener("input", filterArticles);

    document.getElementById("clearFilters")?.addEventListener("click", () => {
      selectedDateSort = "";
      selectedAgency = "";
      selectedTopics = [];
      dateSelect.clear(true);
      agencySelect.clear(true);
      topicSelect.clear(true);
      resetAgency();
      resetTopics();
      document.getElementById("projSearch").value = "";
      filterArticles();
    });

    function updateTopicsByAgency(agency) {
      topicSelect.clearOptions();
      topics
        .filter((t) => t.agency === agency)
        .forEach((topic) => {
          topicSelect.addOption({ value: topic.value, text: topic.value });
        });
      topicSelect.refreshOptions(false);
    }

    function resetTopics() {
      topicSelect.clearOptions();
      topics.forEach((topic) => {
        topicSelect.addOption({ value: topic.value, text: topic.value });
      });
      topicSelect.refreshOptions(false);
    }

    function updateAgencyDropdown(agency) {
      agencySelect.clearOptions();
      agencySelect.addOption({ value: agency, text: agency });
      agencySelect.refreshOptions(false);
      agencySelect.setValue(agency, true);
    }

    function resetAgency() {
      agencySelect.clearOptions();
      agencies.forEach((a) => agencySelect.addOption({ value: a, text: a }));
      agencySelect.refreshOptions(false);
    }

    function filterArticles() {
      const searchText = document
        .getElementById("projSearch")
        .value.trim()
        .toLowerCase();
      const articles = document.querySelectorAll("article");
      articles.forEach((article) => {
        let textContent = article.textContent
          .replace(/\s+/g, " ")
          .toLowerCase();
        let agency = (article.dataset.agency || "").toLowerCase();
        let topicsJson = article.dataset.topic || "[]";
        let topicsArray = [];
        try {
          topicsArray = JSON.parse(topicsJson).map((t) => t.toLowerCase());
        } catch (e) {
          console.error("Invalid topic JSON:", topicsJson);
        }

        const matchSearch =
          searchText === "" || textContent.includes(searchText);
        const matchAgency =
          selectedAgency === "" ||
          agency.includes(selectedAgency.toLowerCase());
        const matchTopics =
          selectedTopics.length === 0 ||
          selectedTopics.some((t) => topicsArray.includes(t.toLowerCase()));

        article.style.display =
          matchSearch && matchAgency && matchTopics ? "block" : "none";
      });
    }

    // Initialize
    resetAgency();
    resetTopics();
  }
</script> -->

<!--CORRECT JS-->
<!-- <script>
  function initFilters({ topics, dateOptions = [] }) {
    let selectedAgency = "";
    let selectedTopics = [];
    let selectedDateSort = "";

    // Collect all agencies
    const agencies = [...new Set(topics.map((t) => t.agency))];

    // Map of topic to its associated agencies
    const topicToAgencies = {};
    topics.forEach((t) => {
      if (!topicToAgencies[t.value]) topicToAgencies[t.value] = new Set();
      topicToAgencies[t.value].add(t.agency);
    });

    const agencySelect = new TomSelect("#agencySelect", {
      plugins: {
        clear_button: {
          title: "Remove all selected options",
        },
      },
      create: false,
      allowEmptyOption: true,
      onChange: (value) => {
        selectedAgency = value || "";
        if (selectedAgency) {
          updateTopicsByAgency(selectedAgency);
        } else {
          resetTopics();
        }
        filterArticles();
      },
    });

    const topicSelect = new TomSelect("#topicSelect", {
      plugins: ["remove_button"],
      create: false,
      persist: false,
      onChange: (values) => {
        selectedTopics = values || [];

        if (selectedTopics.length > 0) {
          // Get union of agencies for all selected topics
          const validAgencies = new Set();
          selectedTopics.forEach((topic) => {
            topicToAgencies[topic]?.forEach((a) => validAgencies.add(a));
          });

          updateAgencyDropdown([...validAgencies]);
        } else {
          resetAgency();
        }

        filterArticles();
      },
    });

    const dateSelect = new TomSelect("#dateSelect", {
      plugins: {
        clear_button: {
          title: "Remove all selected options",
        },
      },
      create: false,
      allowEmptyOption: true,
      options: dateOptions.map((d) => ({ value: d, text: d })),
      onChange: (value) => {
        selectedDateSort = value || "";
        filterArticles();
      },
    });

    document
      .getElementById("projSearch")
      ?.addEventListener("input", filterArticles);

    document.getElementById("clearFilters")?.addEventListener("click", () => {
      selectedDateSort = "";
      selectedAgency = "";
      selectedTopics = [];
      dateSelect.clear(true);
      agencySelect.clear(true);
      topicSelect.clear(true);
      resetAgency();
      resetTopics();
      document.getElementById("projSearch").value = "";
      filterArticles();
    });

    function updateTopicsByAgency(agency) {
      topicSelect.clearOptions();
      topics
        .filter((t) => t.agency === agency)
        .forEach((topic) => {
          topicSelect.addOption({ value: topic.value, text: topic.value });
        });
      topicSelect.refreshOptions(false);
    }

    function resetTopics() {
      topicSelect.clearOptions();
      topics.forEach((topic) => {
        topicSelect.addOption({ value: topic.value, text: topic.value });
      });
      topicSelect.refreshOptions(false);
    }

    function updateAgencyDropdown(agencyList) {
      agencySelect.clearOptions();
      agencyList.forEach((a) => {
        agencySelect.addOption({ value: a, text: a });
      });
      agencySelect.refreshOptions(false);

      if (
        agencyList.length === 1 &&
        (!selectedAgency || agencyList[0] !== selectedAgency)
      ) {
        agencySelect.setValue(agencyList[0], true);
        selectedAgency = agencyList[0];
        updateTopicsByAgency(selectedAgency);
      }
    }

    function resetAgency() {
      agencySelect.clearOptions();
      agencies.forEach((a) => agencySelect.addOption({ value: a, text: a }));
      agencySelect.refreshOptions(false);
    }

    function filterArticles() {
      const searchText = document
        .getElementById("projSearch")
        .value.trim()
        .toLowerCase();
      const articles = document.querySelectorAll("article");

      articles.forEach((article) => {
        let textContent = article.textContent
          .replace(/\s+/g, " ")
          .toLowerCase();
        let agency = (article.dataset.agency || "").toLowerCase();
        let topicsJson = article.dataset.topic || "[]";
        let topicsArray = [];
        try {
          topicsArray = JSON.parse(topicsJson).map((t) => t.toLowerCase());
        } catch (e) {
          console.error("Invalid topic JSON:", topicsJson);
        }

        const matchSearch =
          searchText === "" || textContent.includes(searchText);
        const matchAgency =
          selectedAgency === "" ||
          agency.includes(selectedAgency.toLowerCase());
        const matchTopics =
          selectedTopics.length === 0 ||
          selectedTopics.some((t) => topicsArray.includes(t.toLowerCase()));

        article.style.display =
          matchSearch && matchAgency && matchTopics ? "block" : "none";
      });
    }

    // Init on load
    resetAgency();
    resetTopics();
  }
</script> -->

<script>
  function initFilters({ topics, dateOptions = [] }) {
    let selectedAgency = "";
    let selectedTopics = [];
    let selectedDateSort = "";

    const agencies = [...new Set(topics.map((t) => t.agency))];

    const topicToAgencies = {};
    topics.forEach((t) => {
      if (!topicToAgencies[t.value]) topicToAgencies[t.value] = new Set();
      topicToAgencies[t.value].add(t.agency);
    });

    const agencySelect = new TomSelect("#agencySelect", {
      plugins: {
        clear_button: {
          title: "Remove all selected options",
        },
      },
      create: false,
      allowEmptyOption: true,
      onChange: (value) => {
        selectedAgency = value || "";
        if (selectedAgency) {
          updateTopicsByAgency(selectedAgency);
        } else {
          resetTopics();
        }
        filterArticles();
      },
    });

    const topicSelect = new TomSelect("#topicSelect", {
      plugins: ["remove_button"],
      create: false,
      persist: false,
      onChange: (values) => {
        selectedTopics = values || [];

        if (selectedTopics.length > 0) {
          const validAgencies = new Set();
          selectedTopics.forEach((topic) => {
            topicToAgencies[topic]?.forEach((a) => validAgencies.add(a));
          });

          updateAgencyDropdown([...validAgencies]);
        } else {
          // NEW: Reset agency dropdown when all topics are deselected
          selectedAgency = ""; // Clear selected agency state
          agencySelect.clear(true); // Clear selected agency value
          resetAgency(); // Reset agency options
          resetTopics();
        }

        filterArticles();
      },
    });

    /*  const dateSelect = new TomSelect("#dateSelect", {
      plugins: {
        clear_button: {
          title: "Remove all selected options",
        },
      },
      create: false,
      allowEmptyOption: true,
      options: dateOptions.map((d) => ({ value: d, text: d })),
      onChange: (value) => {
        selectedDateSort = value || "";
        filterArticles();
      },
    });
 */
    document
      .getElementById("projSearch")
      ?.addEventListener("input", filterArticles);

    document.getElementById("clearFilters")?.addEventListener("click", () => {
      selectedDateSort = "";
      selectedAgency = "";
      selectedTopics = [];
      //dateSelect.clear(true);
      agencySelect.clear(true);
      topicSelect.clear(true);
      resetAgency();
      resetTopics();
      document.getElementById("projSearch").value = "";
      filterArticles();
    });

    function updateTopicsByAgency(agency) {
      topicSelect.clearOptions();
      topics
        .filter((t) => t.agency === agency)
        .forEach((topic) => {
          topicSelect.addOption({ value: topic.value, text: topic.value });
        });
      topicSelect.refreshOptions(false);
    }

    function resetTopics() {
      topicSelect.clearOptions();
      topics.forEach((topic) => {
        topicSelect.addOption({ value: topic.value, text: topic.value });
      });
      topicSelect.refreshOptions(false);
    }

    function updateAgencyDropdown(agencyList) {
      agencySelect.clearOptions();

      if (agencyList.length === 0) {
        resetAgency(); // ✅ Defensive fallback

        return;
      }

      agencyList.forEach((a) => {
        agencySelect.addOption({ value: a, text: a });
      });
      agencySelect.refreshOptions(false);

      if (
        agencyList.length === 1 &&
        (!selectedAgency || agencyList[0] !== selectedAgency)
      ) {
        agencySelect.setValue(agencyList[0], true);
        selectedAgency = agencyList[0];
        updateTopicsByAgency(selectedAgency);
      }
    }

    function resetAgency() {
      agencySelect.clearOptions();
      agencies.forEach((a) => agencySelect.addOption({ value: a, text: a }));
      agencySelect.refreshOptions(false);
    }

    function filterArticles() {
      const searchText = document
        .getElementById("projSearch")
        .value.trim()
        .toLowerCase();
      const articles = document.querySelectorAll("article");

      articles.forEach((article) => {
        let textContent = article.textContent
          .replace(/\s+/g, " ")
          .toLowerCase();
        let agency = (article.dataset.agency || "").toLowerCase();
        let topicsJson = article.dataset.topic || "[]";
        let topicsArray = [];
        try {
          topicsArray = JSON.parse(topicsJson).map((t) => t.toLowerCase());
        } catch (e) {
          console.error("Invalid topic JSON:", topicsJson);
        }

        const matchSearch =
          searchText === "" || textContent.includes(searchText);
        const matchAgency =
          selectedAgency === "" ||
          agency.includes(selectedAgency.toLowerCase());
        const matchTopics =
          selectedTopics.length === 0 ||
          selectedTopics.some((t) => topicsArray.includes(t.toLowerCase()));

        article.style.display =
          matchSearch && matchAgency && matchTopics ? "block" : "none";
      });
    }

    // Init on load
    resetAgency();
    resetTopics();
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const pageUrl = encodeURIComponent(window.location.href);
    const pageTitle = encodeURIComponent(document.title);

    // Facebook
    document
      .querySelector('[aria-label="Facebook"]')
      .addEventListener("click", function () {
        window.open(
          `https://www.facebook.com/sharer/sharer.php?u=${pageUrl}`,
          "_blank"
        );
      });

    // Twitter/X
    document
      .querySelector('[aria-label="X / Twitter"]')
      .addEventListener("click", function () {
        window.open(
          `https://twitter.com/intent/tweet?url=${pageUrl}&text=${pageTitle}`,
          "_blank"
        );
      });

    // LinkedIn
    document
      .querySelector('[aria-label="LinkedIn"]')
      .addEventListener("click", function () {
        window.open(
          `https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`,
          "_blank"
        );
      });

    // Email

    document
      .querySelector('[aria-label="e-mail"]')
      .addEventListener("click", function () {
        const subject = encodeURIComponent(
          "Sharing a wonderful project opportunity!"
        );
        const body = encodeURIComponent(
          `Hi,\n\nI wanted to share this great opportunity with you. Check it out here: ${window.location.href}`
        );
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      });
  });
</script>
